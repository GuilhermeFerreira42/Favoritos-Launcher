<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Favoritos</title>
    
    <style>
        /* --- Reset Básico e Estilos Globais --- */
        :root {
            --background-start: #1e3a8a; /* Azul escuro */ 
            --background-end: #0c1a4d; /* Azul mais escuro */ 
            --group-background: rgba(17, 24, 39, 0.7); /* Fundo do grupo semi-transparente */ 
            --text-color: #f1f5f9; /* Branco acinzentado */ 
            --border-color: rgba(255, 255, 255, 0.1);
            --hover-shadow: 0 0 15px rgba(59, 130, 246, 0.5); /* Sombra azul no hover */ 
        }

        * {
            margin: 0;
            padding: 0; 
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: var(--text-color); 
            background-color: var(--background-end); 
            background-image: linear-gradient(145deg, var(--background-start), var(--background-end)); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            min-height: 100vh;
        }

        /* --- Estrutura Principal --- */
        .container {
            max-width: 100%; /* Ocupar toda a largura para o scroll horizontal */
            margin: 0 auto; 
            padding: 2rem;
        }

        /* --- Barra Superior --- */
        .top-bar {
            display: flex;
            justify-content: center; 
            align-items: center; 
            margin-bottom: 2rem;
            position: relative; 
            padding: 0 2rem; /* Adicionado para não colar nas bordas em telas menores */
        }

        .search-bar {
            width: 100%;
            max-width: 500px; 
            padding: 0.75rem 1.5rem; 
            border-radius: 50px; 
            border: 1px solid var(--border-color); 
            background-color: var(--group-background); 
            color: var(--text-color); 
            font-size: 1rem; 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); 
        }

        .search-bar::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .context-menu-btn {
            position: absolute;
            right: 2rem; /* Alinhado com o padding do container */
            top: 50%; 
            transform: translateY(-50%); 
            background: none; 
            border: none; 
            color: var(--text-color); 
            font-size: 1.5rem; 
            cursor: pointer; 
            padding: 0.5rem;
        }

        /* --- Container dos Grupos (PASSO 1) --- */
        #groups-container {
            /* Passo 1.1: Alterar para display: flex */
            display: flex;
            /* Passo 1.1: Adicionar overflow-x: auto para scroll horizontal */
            overflow-x: auto;
            /* Passo 1.3: Definir uma altura mínima */
            min-height: 60vh;
            /* Passo 1.2: Adicionar padding */
            padding: 1rem 0;
            gap: 2rem; /* Espaçamento entre os grupos */
        }

        /* --- Estilo de cada Grupo (e Subgrupo) --- */
        .group {
            /* Passo 1: Ajustes para layout flex */
            width: 340px; /* Largura fixa para cada grupo */
            flex-shrink: 0; /* Impede que o grupo encolha */
            
            background-color: var(--group-background);
            border-radius: 16px; 
            padding: 1.5rem; 
            border: 1px solid var(--border-color); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            height: fit-content; /* Para que a altura se ajuste ao conteúdo */
        }

        .group.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); 
        }

        .group-header {
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1.5rem;
            cursor: grab; /* Indica que o header pode ser arrastado */
        }

        .group-header:active {
            cursor: grabbing;
        }

        .group-header h2 {
            font-size: 1.1rem;
            font-weight: 600; 
            letter-spacing: 1px; 
        }
        
        .group-header-actions {
            display: flex;
            align-items: center; 
            gap: 8px; 
        }

        .add-favorite-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none; 
            color: var(--text-color); 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            font-size: 1.5rem; 
            cursor: pointer; 
            transition: background-color 0.2s;
        }

        .add-favorite-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .group-context-btn {
            background: none;
            border: none; 
            color: var(--text-color); 
            font-size: 1.5rem; 
            cursor: pointer; 
            padding: 0.5rem; 
            border-radius: 50%; 
            transition: background-color 0.2s;
        }

        .group-context-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* --- Grade de Favoritos --- */
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); 
            gap: 1.5rem;
            min-height: 80px; /* Altura mínima para ser uma área de drop válida */
        }

        .favorite-item {
            position: relative;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 0.5rem; 
            text-decoration: none; 
            color: var(--text-color); 
            transition: transform 0.2s ease-in-out; 
            cursor: pointer;
        }
        
        .favorite-item:hover {
            transform: scale(1.08);
        }

        .favorite-item .favicon-container {
            width: 60px;
            height: 60px; 
            border-radius: 12px; 
            background-color: rgba(0, 0, 0, 0.2); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); 
        }

        .favorite-item img {
            width: 100%;
            height: 100%; 
            object-fit: cover; 
        }

        .favorite-item .name {
            font-size: 0.8rem;
            text-align: center; 
            width: 100%; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        
        .favorite-actions {
            position: absolute;
            top: -5px; 
            right: -5px; 
            display: flex; 
            gap: 5px; 
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.2s, visibility 0.2s; 
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.7); 
            border-radius: 12px; 
            padding: 3px; 
        }

        .favorite-item:hover .favorite-actions {
            opacity: 1;
            visibility: visible; 
        }

        .action-btn {
            background-color: transparent;
            border: none; 
            color: white; 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            font-size: 12px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 0; 
            transition: background-color 0.2s; 
        }

        .action-btn:hover {
            background-color: rgba(59, 130, 246, 0.5);
        }

        .delete-fav-btn:hover {
            background-color: rgba(239, 68, 68, 0.5);
        }

        /* --- Estilos de Hierarquia (Subgrupos) --- */
        .subgroup-container {
            margin-top: 1.5rem;
            padding-left: 1rem;
            border-left: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .subgroup {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0; /* Removido para usar o gap do container */
            width: auto; /* Subgrupos ocupam a largura do pai */
            flex-shrink: 1;
        }

        /* --- Estilos do Modal --- */
        .modal {
            display: none;
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px); 
            align-items: center; 
            justify-content: center; 
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--group-background);
            padding: 2rem; 
            border-radius: 16px; 
            border: 1px solid var(--border-color); 
            width: 90%; 
            max-width: 400px; 
            position: relative;
        }

        .modal-content .close-btn {
            position: absolute;
            top: 10px; 
            right: 20px; 
            color: var(--text-color); 
            font-size: 2rem; 
            font-weight: bold; 
            cursor: pointer;
        }
        
        .modal-content h3 {
            margin-bottom: 1.5rem;
            text-align: center; 
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem; 
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem; 
            background-color: rgba(0, 0, 0, 0.2); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            color: var(--text-color); 
            font-size: 1rem;
        }
        
        .btn-primary {
            width: 100%;
            padding: 0.75rem; 
            border: none; 
            border-radius: 8px; 
            background-color: #3b82f6; 
            color: white; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 1rem;
        }

        /* Classe utilitária para esconder elementos */
        .hidden {
            display: none !important;
        }

        /* Menus de Contexto */
        .context-menu-wrapper {
            display: none;
            position: absolute; 
            background-color: var(--group-background); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.3); 
            z-index: 1100; 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); 
        }

        .context-menu-wrapper.show {
            display: block;
        }

        .context-menu-wrapper ul {
            list-style: none;
            padding: 0.5rem 0; 
            margin: 0; 
        }

        .context-menu-wrapper li {
            padding: 0.75rem 1.5rem;
            cursor: pointer; 
            transition: background-color 0.2s; 
            white-space: nowrap; 
        }
        
        .context-menu-wrapper li:hover {
            background-color: rgba(59, 130, 246, 0.2);
        }

        #group-context-menu {
            width: 180px;
            box-sizing: border-box; 
        }

        #group-context-menu li {
            padding: 0.75rem 1rem;
        }

        /* --- Estilos para Drag and Drop (PASSO 1 e 3) --- */
        .favorite-item.dragging {
            opacity: 0.5;
            cursor: grabbing; 
        }
        
        /* Estilo para o grupo sendo arrastado */
        .group.dragging {
            opacity: 0.6;
            cursor: grabbing;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(1.02);
        }

        /* Estilo para o grupo que é um alvo de drop (aninhamento) */
        .group.over {
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
        }

        .favorites-grid.drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            border: 2px dashed rgba(59, 130, 246, 0.4); 
            border-radius: 12px; 
        }
        
    </style>
</head>
<body>

    <div class="container">
        <header class="top-bar">
            <input type="search" id="search-bar" class="search-bar" placeholder="🔎 Pesquisar">
            <button class="context-menu-btn" title="Menu">⋮</button>
        </header>

        <div id="context-menu" class="context-menu-wrapper">
            <ul>
                <li data-action="change-wallpaper">Trocar papel de parede</li> 
                <li data-action="restore-wallpaper">Restaurar papel de parede</li> 
                <li data-action="import">Importar favoritos</li> 
                <li data-action="export">Exportar favoritos</li> 
                <li data-action="create-group">Criar novo grupo</li> 
            </ul>
        </div>

        <div id="group-context-menu" class="context-menu-wrapper">
            <ul>
                <li data-action="rename-group">Renomear Grupo</li> 
                <li data-action="delete-group" style="color: #fca5a5;">Excluir Grupo</li> 
            </ul>
        </div>

        <main id="groups-container">
            </main>
    </div>

    <div id="add-favorite-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">×</span>
            <h3 id="modal-title">Adicionar Novo Favorito</h3>
            <form id="add-favorite-form">
                <div class="form-group">
                    <label for="favorite-name">Nome</label>
                    <input type="text" id="favorite-name" required> 
                </div>
                <div class="form-group">
                    <label for="favorite-url">URL</label>
                    <input type="url" id="favorite-url" placeholder="https://exemplo.com" required> 
                </div>
                <button type="submit" class="btn-primary" id="modal-submit-btn">Salvar</button>
            </form>
        </div>
    </div>

    <input type="file" id="wallpaper-input" class="hidden" accept="image/*">
    <input type="file" id="import-input" class="hidden" accept=".html,text/html">

<script>
    // --- Funções de Exportação ---
    function generateExportHTML() {
        let htmlContent = `<!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <title>Meus Favoritos Exportados</title>
        <style>
            body { font-family: sans-serif; line-height: 1.6; }
            h1 { border-bottom: 2px solid #333; }
            h2 { margin-top: 2em; }
            a { text-decoration: none; color: #0066cc; }
            a:hover { text-decoration: underline; }
        </style>
    </head>
    <body>
        <h1>Meus Favoritos</h1>`;
        appData.groups.forEach(group => {
            htmlContent += `
        <h2>${group.name}</h2>
        <ul>`;
            group.favorites.forEach(fav => {
                htmlContent += `
            <li><a href="${fav.url}">${fav.name}</a></li>`;
            });
            htmlContent += `
        </ul>`;
        });
        htmlContent += `
    </body>
    </html>`;
        return htmlContent;
    }

    function exportFavorites() {
        const htmlContent = generateExportHTML();
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `favoritos_exportados_${new Date().toLocaleDateString()}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }

    // --- Camada de Lógica e Persistência ---
    const defaultData = {
        "groups": [
            {
                "id": "group1",
                "name": "FERRAMENTAS DE IA",
                "favorites": [
                    { "id": "fav1", "name": "Perplexity AI", "url": "https://www.perplexity.ai/"  },
                    { "id": "fav2", "name": "Grok Beta", "url": "https://grok.x.ai/"  },
                    { "id": "fav3", "name": "Claude", "url": "https://claude.ai/"  },
                    { "id": "fav4", "name": "Google Gemini", "url": "https://gemini.google.com/"  },
                    { "id": "fav5", "name": "ChatGPT", "url": "https://chat.openai.com/"  }
                ],
                "subgroups": []
            },
            {
                "id": "group2",
                "name": "TRABALHO",
                "favorites": [
                    { "id": "fav6", "name": "Google Drive", "url": "https://drive.google.com/"  },
                    { "id": "fav7", "name": "GitHub", "url": "https://github.com/"  },
                    { "id": "fav8", "name": "Figma", "url": "https://www.figma.com/"  },
                    { "id": "fav9", "name": "Trello", "url": "https://trello.com/"  }
                ],
                "subgroups": []
            },
            {
                "id": "group3",
                "name": "MÍDIA E ENTRETENIMENTO",
                "favorites": [
                    { "id": "fav10", "name": "YouTube", "url": "https://www.youtube.com/"  },
                    { "id": "fav11", "name": "Netflix", "url": "https://www.netflix.com/"  },
                    { "id": "fav12", "name": "Spotify", "url": "https://www.spotify.com/"  }
                ],
                "subgroups": []
            }
        ],
        "background": null
    };

    let appData = {};
    let draggedItem = null;
    let draggedGroupInfo = null;
    let sourceGroupIdForFav = null;
    let currentGroupId = null;
    let editState = { enabled: false, favoriteId: null };
    let activeGroupId = null;

    function loadData() {
        const savedData = localStorage.getItem('launcherFavorites');
        if (savedData) {
            appData = JSON.parse(savedData);
        } else {
            appData = defaultData;
            saveData();
        }
    }

    function saveData() {
        localStorage.setItem('launcherFavorites', JSON.stringify(appData));
    }

    // --- Funções de Papel de Parede ---
    function applyWallpaper() {
        const savedWallpaper = appData.background;
        if (savedWallpaper) {
            document.body.style.backgroundImage = `url(${savedWallpaper})`;
        } else {
            document.body.style.backgroundImage = 'linear-gradient(145deg, var(--background-start), var(--background-end))';
        }
    }

    function handleWallpaperSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageDataUrl = e.target.result;
            appData.background = imageDataUrl;
            saveData();
            applyWallpaper();
        };
        reader.readAsDataURL(file);
    }

    function openWallpaperSelector() {
        document.getElementById('wallpaper-input').click();
    }

    function restoreDefaultWallpaper() {
        appData.background = null;
        saveData();
        applyWallpaper();
        console.log('Papel de parede restaurado para o padrão.');
    }

    // --- Funções de Importação ---
    function parseBookmarks(htmlString) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const mainDl = doc.querySelector('dl');
        if (!mainDl) {
            alert('Arquivo de favoritos inválido ou em formato não reconhecido.');
            return [];
        }
        return buildTree(mainDl);
    }

    function buildTree(dlElement) {
        const items = [];
        const dtElements = dlElement.querySelectorAll(':scope > dt');
        dtElements.forEach(dt => {
            const h3 = dt.querySelector('h3');
            if (h3) {
                const folderName = h3.textContent.trim();
                const nestedDl = dt.querySelector('dl');
                const children = nestedDl ? buildTree(nestedDl) : [];
                items.push({
                    type: 'folder',
                    name: folderName,
                    children: children
                });
            } else {
                const link = dt.querySelector('a');
                if (link) {
                    items.push({
                        type: 'bookmark',
                        name: link.textContent.trim(),
                        url: link.href
                    });
                }
            }
        });
        return items;
    }

    function convertTreeToAppGroups(tree) {
        const groups = [];
        const topLevelFolders = tree.filter(item => item.type === 'folder');
        const topLevelBookmarks = tree.filter(item => item.type === 'bookmark');
        if (topLevelBookmarks.length > 0) {
            groups.push({
                id: `group-${Date.now()}-root`,
                name: 'Favoritos da Barra',
                favorites: topLevelBookmarks.map(b => ({
                    id: `fav-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    name: b.name,
                    url: b.url
                })),
                subgroups: []
            });
        }
        topLevelFolders.forEach(folder => {
            groups.push(convertFolderToGroup(folder, `group-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`));
        });
        return groups;
    }

    function convertFolderToGroup(folder, id) {
        const group = {
            id: id,
            name: folder.name,
            favorites: [],
            subgroups: []
        };
        folder.children.forEach(child => {
            if (child.type === 'bookmark') {
                group.favorites.push({
                    id: `fav-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    name: child.name,
                    url: child.url
                });
            } else if (child.type === 'folder') {
                group.subgroups.push(convertFolderToGroup(child, `group-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`));
            }
        });
        return group;
    }

    function handleImportSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const htmlContent = e.target.result;
            try {
                const parsedTree = parseBookmarks(htmlContent);
                const importedGroups = convertTreeToAppGroups(parsedTree);
                appData.groups = [...appData.groups, ...importedGroups];
                saveData();
                render();
                alert(`Importação concluída com sucesso!`);
            } catch (error) {
                console.error('Erro ao importar favoritos:', error);
                alert('Ocorreu um erro ao tentar importar o arquivo.');
            }
        };
        reader.readAsText(file);
    }

    function openImportSelector() {
        document.getElementById('import-input').click();
    }

    // --- Funções Auxiliares para Manipulação de Grupos ---
    function findGroupById(id, groups = appData.groups) {
        for (let i = 0; i < groups.length; i++) {
            const group = groups[i];
            if (group.id === id) {
                return { group: group, parentArray: groups, index: i };
            }
            if (group.subgroups && group.subgroups.length > 0) {
                const found = findGroupById(id, group.subgroups);
                if (found) {
                    return found;
                }
            }
        }
        return null;
    }

    function isDescendant(sourceGroup, targetId) {
        if (sourceGroup.id === targetId) return true;
        if (sourceGroup.subgroups && sourceGroup.subgroups.length > 0) {
            for (const subgroup of sourceGroup.subgroups) {
                if (isDescendant(subgroup, targetId)) {
                    return true;
                }
            }
        }
        return false;
    }

    // --- Função auxiliar para determinar posição de drop ---
    function getDragAfterElement(container, x) {
        const draggableElements = [...container.children].filter(child => 
            !child.classList.contains('dragging') && child.classList.contains('group')
        );
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // --- Camada de Apresentação ---
    function renderHierarquia(groups, container) {
        groups.forEach(group => {
            const groupElement = document.createElement('section');
            groupElement.className = group.subgroups.length > 0 ? 'group has-subgroups' : 'group';
            groupElement.dataset.groupId = group.id;
            groupElement.draggable = true;
            
            groupElement.innerHTML = `
                <div class="group-header">
                    <h2>${group.name}</h2>
                    <div class="group-header-actions">
                        <button class="add-favorite-btn" title="Adicionar Favorito">+</button>
                        <button class="group-context-btn" title="Opções do Grupo">⋮</button>
                    </div>
                </div>
                <div class="favorites-grid"></div>
                <div class="subgroup-container"></div>
            `;
            
            const favoritesGrid = groupElement.querySelector('.favorites-grid');
            group.favorites.forEach(fav => {
                const faviconUrl = `https://www.google.com/s2/favicons?sz=64&domain_url=${fav.url}`;
                const favoriteElement = document.createElement('div');
                favoriteElement.draggable = true;
                favoriteElement.className = 'favorite-item';
                favoriteElement.dataset.favoriteId = fav.id;
                
                favoriteElement.innerHTML = `
                    <div class="favorite-actions">
                        <button class="action-btn edit-fav-btn" title="Editar">✏️</button>
                        <button class="action-btn delete-fav-btn" title="Excluir">❌</button>
                    </div>
                    <a href="${fav.url}" target="_blank" class="favicon-container" title="${fav.name}">
                        <img src="${faviconUrl}" alt="Favicon de ${fav.name}" onerror="this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'">
                    </a>
                    <span class="name">${fav.name}</span>
                `;
                
                favoritesGrid.appendChild(favoriteElement);
            });

            if (group.subgroups && group.subgroups.length > 0) {
                const subgroupContainer = groupElement.querySelector('.subgroup-container');
                renderHierarquia(group.subgroups, subgroupContainer);
            }

            container.appendChild(groupElement);
        });
    }

    function render() {
        const groupsContainer = document.getElementById('groups-container');
        groupsContainer.innerHTML = '';
        if (!appData.groups) return;
        renderHierarquia(appData.groups, groupsContainer);
    }

    // --- Inicialização ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        render();
        applyWallpaper();

        const groupsContainer = document.getElementById('groups-container');
        const searchBar = document.getElementById('search-bar');
        const modal = document.getElementById('add-favorite-modal');
        const closeModalBtn = modal.querySelector('.close-btn');
        const addFavoriteForm = document.getElementById('add-favorite-form');
        const contextMenuBtn = document.querySelector('.context-menu-btn');
        const contextMenu = document.getElementById('context-menu');
        const groupContextMenu = document.getElementById('group-context-menu');
        const wallpaperInput = document.getElementById('wallpaper-input');
        const importInput = document.getElementById('import-input');

        // --- Event Listeners ---
        groupsContainer.addEventListener('dragstart', (e) => {
            if (e.target.closest('.group-header-actions button')) {
                e.preventDefault();
                return;
            }
            
            const favoriteItem = e.target.closest('.favorite-item');
            const groupHeader = e.target.closest('.group-header');
            
            if (favoriteItem) {
                draggedItem = favoriteItem;
                sourceGroupIdForFav = e.target.closest('.group').dataset.groupId;
                setTimeout(() => {
                    draggedItem.classList.add('dragging');
                }, 0);
            } else if (groupHeader) {
                const groupElement = groupHeader.closest('.group');
                const groupId = groupElement.dataset.groupId;
                draggedGroupInfo = findGroupById(groupId);
                if (draggedGroupInfo) {
                    setTimeout(() => {
                        groupElement.classList.add('dragging');
                    }, 0);
                }
            }
        });

        groupsContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            document.querySelectorAll('.group.over').forEach(g => g.classList.remove('over'));
            
            if (draggedGroupInfo) {
                const nestingTarget = e.target.closest('.group:not(.dragging) .group-header');
                const dropContainer = e.target.closest('#groups-container, .subgroup-container'); 
                
                if (nestingTarget) {
                    const targetGroupElement = nestingTarget.closest('.group');
                    if (!isDescendant(draggedGroupInfo.group, targetGroupElement.dataset.groupId)) {
                        targetGroupElement.classList.add('over');
                    }
                } else if (dropContainer) {
                    const afterElement = getDragAfterElement(dropContainer, e.clientX);
                    const draggedElement = document.querySelector('.group.dragging');
                    if (draggedElement) {
                        if (afterElement) {
                            dropContainer.insertBefore(draggedElement, afterElement);
                        } else {
                            dropContainer.appendChild(draggedElement);
                        }
                    }
                }
            } else if (draggedItem) {
                const targetGrid = e.target.closest('.favorites-grid');
                if (targetGrid) {
                    document.querySelectorAll('.favorites-grid.drag-over').forEach(grid => grid.classList.remove('drag-over'));
                    targetGrid.classList.add('drag-over');
                }
            }
        });

        groupsContainer.addEventListener('dragleave', (e) => {
            const targetGroup = e.target.closest('.group');
            if (targetGroup) {
                targetGroup.classList.remove('over');
            }
        });

        groupsContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            document.querySelectorAll('.group.over').forEach(g => g.classList.remove('over'));
            
            if (draggedGroupInfo) {
                const sourceGroupData = draggedGroupInfo.group;
                const sourceParentArray = draggedGroupInfo.parentArray;
                const sourceIndex = draggedGroupInfo.index;
                
                const nestingTarget = e.target.closest('.group:not(.dragging) .group-header');
                
                if (nestingTarget) {
                    const targetGroupElement = nestingTarget.closest('.group');
                    if (isDescendant(sourceGroupData, targetGroupElement.dataset.groupId)) {
                        alert("Não é possível mover um grupo para dentro de si mesmo.");
                        render();
                        return;
                    }
                    
                    const targetGroupInfo = findGroupById(targetGroupElement.dataset.groupId);
                    if (targetGroupInfo) {
                        sourceParentArray.splice(sourceIndex, 1);
                        if (!targetGroupInfo.group.subgroups) targetGroupInfo.group.subgroups = [];
                        targetGroupInfo.group.subgroups.push(sourceGroupData);
                    }
                } else {
                    const draggedElement = document.querySelector('.group.dragging');
                    const dropContainer = draggedElement ? draggedElement.parentElement : null;
                    
                    if (dropContainer) {
                        const newIndex = [...dropContainer.children].indexOf(draggedElement);
                        sourceParentArray.splice(sourceIndex, 1);
                        
                        let targetArray;
                        const targetParentGroupEl = dropContainer.closest('.group');
                        
                        if (targetParentGroupEl) {
                            const targetParentInfo = findGroupById(targetParentGroupEl.dataset.groupId);
                            if (!targetParentInfo.group.subgroups) targetParentInfo.group.subgroups = [];
                            targetArray = targetParentInfo.group.subgroups;
                        } else {
                            targetArray = appData.groups;
                        }
                        
                        targetArray.splice(newIndex, 0, sourceGroupData);
                    }
                }
                
                saveData();
                render();
            } else if (draggedItem) {
                if (!targetGroupElement) return;
                const targetGroupId = targetGroupElement.dataset.groupId;
                const favoriteId = draggedItem.dataset.favoriteId;
                const sourceGroupInfo = findGroupById(sourceGroupIdForFav);
                const favoriteIndex = sourceGroupInfo.group.favorites.findIndex(f => f.id === favoriteId);
                
                if (favoriteIndex === -1) return;
                
                const [favoriteToMove] = sourceGroupInfo.group.favorites.splice(favoriteIndex, 1);
                const targetGroupInfo = findGroupById(targetGroupId);
                targetGroupInfo.group.favorites.push(favoriteToMove);
                
                saveData();
                render();
            }
        });

        groupsContainer.addEventListener('dragend', (e) => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
                sourceGroupIdForFav = null;
                document.querySelectorAll('.favorites-grid.drag-over').forEach(grid => grid.classList.remove('drag-over'));
            }
            
            if (draggedGroupInfo) {
                const groupElement = document.querySelector(`.group.dragging`);
                if (groupElement) groupElement.classList.remove('dragging');
                draggedGroupInfo = null;
            }
        });

        // =================================================================
        // FUNÇÕES E LISTENERS EXISTENTES (MODAL, MENUS, PESQUISA, ETC.)
        // =================================================================
        function openModal(groupId, favorite = null) {
            currentGroupId = groupId;
            editState.enabled = !!favorite;
            editState.favoriteId = favorite ? favorite.id : null;
            modal.querySelector('h3').textContent = favorite ? 'Editar Favorito' : 'Adicionar Novo Favorito';
            document.getElementById('favorite-name').value = favorite ? favorite.name : '';
            document.getElementById('favorite-url').value = favorite ? favorite.url : '';
            modal.classList.add('show');
            document.getElementById('favorite-name').focus();
        }

        function closeModal() {
            addFavoriteForm.reset();
            modal.classList.remove('show');
            currentGroupId = null;
            editState.enabled = false;
            editState.favoriteId = null;
        }

        window.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && !contextMenuBtn.contains(e.target)) {
                contextMenu.classList.remove('show');
            }
            if (!groupContextMenu.contains(e.target) && !e.target.classList.contains('group-context-btn')) {
                groupContextMenu.classList.remove('show');
            }
        });

        contextMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            groupContextMenu.classList.remove('show');
            const rect = contextMenuBtn.getBoundingClientRect();
            contextMenu.style.top = `${rect.bottom + 5}px`;
            contextMenu.style.left = `${rect.right - contextMenu.offsetWidth}px`;
            contextMenu.classList.toggle('show');
        });

        contextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!action) return;            
            switch (action) {
                case 'change-wallpaper': openWallpaperSelector(); break;
                case 'restore-wallpaper': restoreDefaultWallpaper(); break;
                case 'import': openImportSelector(); break;
                case 'export': exportFavorites(); break;
                case 'create-group':
                    const groupName = prompt('Digite o nome do novo grupo:');
                    if (groupName) {
                        const newGroup = {
                            id: 'group' + Date.now(),
                            name: groupName,
                            favorites: [],
                            subgroups: []
                        };
                        appData.groups.push(newGroup);
                        saveData();
                        render();
                    }
                    break;
            }
            contextMenu.classList.remove('show');
        });

        groupContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!action || !activeGroupId) return;
            const groupInfo = findGroupById(activeGroupId);
            if (!groupInfo) return;
            const group = groupInfo.group;
            
            if (action === 'rename-group') {
                const newName = prompt('Digite o novo nome para o grupo:', group.name);
                if (newName && newName.trim()) {
                    group.name = newName.trim();
                    saveData();
                    render();
                }
            } else if (action === 'delete-group') {
                if (confirm(`Tem certeza que deseja excluir o grupo "${group.name}" e tudo que ele contém?`)) {
                    groupInfo.parentArray.splice(groupInfo.index, 1);
                    saveData();
                    render();
                }
            }
            groupContextMenu.classList.remove('show');
        });

        wallpaperInput.addEventListener('change', handleWallpaperSelect);
        importInput.addEventListener('change', handleImportSelect);

        searchBar.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            document.querySelectorAll('.group').forEach(group => {
                let hasVisibleFavorites = false;
                group.querySelectorAll('.favorite-item').forEach(fav => {
                    const name = fav.querySelector('.name').textContent.toLowerCase();
                    const url = fav.querySelector('a').href.toLowerCase();
                    if (name.includes(query) || url.includes(query)) {
                        fav.style.display = '';
                        hasVisibleFavorites = true;
                    } else {
                        fav.style.display = 'none';
                    }
                });
                group.style.display = hasVisibleFavorites || !query ? '' : 'none';
            });
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { 
            e.target === modal && closeModal(); 
        });
        
        addFavoriteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('favorite-name').value;
            const url = document.getElementById('favorite-url').value;
            const groupInfo = findGroupById(currentGroupId);
            
            if (!groupInfo) return;
            
            if (editState.enabled) {
                const favorite = groupInfo.group.favorites.find(f => f.id === editState.favoriteId);
                if (favorite) {
                    favorite.name = name;
                    favorite.url = url;
                }
            } else {
                const newFavorite = { id: 'fav' + Date.now(), name, url };
                groupInfo.group.favorites.push(newFavorite);
            }
            
            saveData();
            render();
            closeModal();
        });

        groupsContainer.addEventListener('click', (e) => {
            const target = e.target;
            const groupElement = target.closest('.group');
            
            if (!groupElement) return;
            
            const groupId = groupElement.dataset.groupId;
            
            if (target.classList.contains('add-favorite-btn')) {
                openModal(groupId);
                return;
            }
            
            if (target.classList.contains('group-context-btn')) {
                e.stopPropagation();
                activeGroupId = groupId;
                document.querySelectorAll('.group').forEach(g => g.classList.remove('selected'));
                groupElement.classList.add('selected');
                const rect = target.getBoundingClientRect();
                contextMenu.classList.remove('show');
                groupContextMenu.style.top = `${rect.bottom + window.scrollY}px`;
                groupContextMenu.style.left = `${rect.left + window.scrollX - groupContextMenu.offsetWidth + rect.width}px`;
                groupContextMenu.classList.add('show');
                return;
            }
            
            const favoriteElement = target.closest('.favorite-item');
            if (!favoriteElement) return;
            
            const groupInfo = findGroupById(groupId);
            if (!groupInfo) return;
            
            if (target.classList.contains('edit-fav-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const favorite = groupInfo.group.favorites.find(f => f.id === favoriteElement.dataset.favoriteId);
                if (favorite) openModal(groupId, favorite);
            } else if (target.classList.contains('delete-fav-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const favIndex = groupInfo.group.favorites.findIndex(f => f.id === favoriteElement.dataset.favoriteId);
                if (favIndex !== -1 && confirm(`Tem certeza que deseja excluir "${groupInfo.group.favorites[favIndex].name}"?`)) {
                    groupInfo.group.favorites.splice(favIndex, 1);
                    saveData();
                    render();
                }
            } else {
                const link = favoriteElement.querySelector('a');
                if (link && link.href) {
                    window.open(link.href, '_blank');
                }
            }
        });
    });
</script>

</body>
</html>