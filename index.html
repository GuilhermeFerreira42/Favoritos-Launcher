<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Favoritos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50%' y='50%' style='font-size: 90px;' text-anchor='middle' dominant-baseline='middle'>üòé</text></svg>">
    
    <style>
        /* --- Reset B√°sico e Estilos Globais --- */
        :root {
            --background-start: #1e3a8a; /* Azul escuro */ 
            --background-end: #0c1a4d; /* Azul mais escuro */ 
            --group-background: rgba(17, 24, 39, 0.7); /* Fundo do grupo semi-transparente */ 
            --text-color: #f1f5f9; /* Branco acinzentado */ 
            --border-color: rgba(255, 255, 255, 0.1);
            --hover-shadow: 0 0 15px rgba(59, 130, 246, 0.5); /* Sombra azul no hover */ 
            --layout-gap: 2rem; /* [NOVO] Variavel para o espa√ßamento */
            --search-bar-width: 500px;
            --favorite-item-size: 60px;
            --favorite-font-size: 0.8rem;
        }

        /* Garante que a base da p√°gina ocupe toda a tela */
        html, body {
            height: 100%;
            overflow: hidden; /* Previne barras de rolagem duplas e indesejadas no corpo da p√°gina */
        }

        * {
            margin: 0;
            padding: 0; 
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: var(--text-color); 
            background-color: var(--background-end); 
            background-image: linear-gradient(145deg, var(--background-start), var(--background-end)); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            min-height: 100vh;
            display: flex; /* Transforma o body em um cont√™iner flex */
        }

        /* --- Estrutura Principal --- */
        .container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 2rem;
            width: 100%;
            overflow: hidden;
        }

        /* --- Barra Superior --- */
        .top-bar {
            display: flex;
            justify-content: center; 
            align-items: center; 
            margin-bottom: 2rem;
            position: relative; 
        }

        .top-bar-action-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.8rem;
            line-height: 1;
            cursor: pointer;
            margin-left: 1rem;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .top-bar-action-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .search-bar {
            width: 100%;
            max-width: var(--search-bar-width);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            background-color: var(--group-background);
            color: var(--text-color);
            font-size: 1rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .search-bar::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .context-menu-btn {
            position: absolute;
            right: 0; 
            top: 50%; 
            transform: translateY(-50%); 
            background: none; 
            border: none; 
            color: var(--text-color); 
            font-size: 1.5rem; 
            cursor: pointer; 
            padding: 0.5rem;
        }

        /* --- Container dos Grupos (Layout Padr√£o) --- */
        #groups-container {
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 1.5rem;
            gap: var(--layout-gap);
            flex-grow: 1;
        }

        /* --- Layout em Grade Centralizado --- */
        #groups-container.layout-centered {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* --- [ALTERADO] Layout Mosaico (Agora controlado por JS) --- */
        #groups-container.layout-masonry {
            position: relative; /* Essencial para o posicionamento absoluto dos filhos */
            justify-content: initial;
            overflow-y: auto;
            overflow-x: hidden;
            gap: 0; /* O gap √© gerenciado pelo JS */
        }
        
        /* --- Estilo de cada Grupo --- */
        .group {
            background-color: var(--group-background);
            border-radius: 16px; 
            padding: 1.5rem; 
            border: 1px solid var(--border-color); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            transition: border-color 0.2s ease, opacity 0.2s ease, top 0.3s ease, left 0.3s ease; /* Adiciona transi√ß√£o para top/left */
            flex-shrink: 0; 
            align-self: flex-start; 
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 10rem);
            /* Reset de estilos para funcionar em todos os layouts */
            position: relative; 
            left: auto;
            top: auto;
        }
        
        /* [NOVO] Estilo espec√≠fico para o bloco no modo Mosaico */
        #groups-container.layout-masonry .group {
            position: absolute; /* Ativado apenas no modo mosaico */
        }
        
        .group.drop-target-group {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }

        .group-header {
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1.5rem;
            cursor: grab;
        }
        .group-header:active {
            cursor: grabbing;
        }

        .group-header h2 {
            font-size: 1.1rem;
            font-weight: 600; 
            letter-spacing: 1px; 
        }
        
        .group-header-actions {
            display: flex;
            align-items: center; 
            gap: 8px; 
        }

        .add-favorite-btn, .group-context-btn {
            cursor: pointer;
        }

        .add-favorite-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none; 
            color: var(--text-color); 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            font-size: 1.5rem; 
            transition: background-color 0.2s;
        }

        .add-favorite-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .group-context-btn {
            background: none;
            border: none; 
            color: var(--text-color); 
            font-size: 1.5rem; 
            padding: 0.5rem; 
            border-radius: 50%; 
            transition: background-color 0.2s;
        }

        .group-context-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); 
            gap: 1.5rem; 
            overflow-y: auto;
            overflow-x: hidden;
            flex-grow: 1;
        }

        .favorite-item {
            position: relative;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 0.5rem; 
            text-decoration: none; 
            color: var(--text-color); 
            transition: transform 0.2s ease-in-out; 
            cursor: pointer;
        }
        
        .favorite-item:hover {
            transform: scale(1.08);
        }

        .favorite-item .favicon-container {
            width: var(--favorite-item-size);
            height: var(--favorite-item-size);
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .favorite-item img {
            width: 100%;
            height: 100%; 
            object-fit: cover; 
        }

        .favorite-item .name {
            font-size: var(--favorite-font-size);
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .favorite-actions {
            position: absolute;
            top: -5px; 
            right: -5px; 
            display: flex; 
            gap: 5px; 
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.2s, visibility 0.2s; 
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.7); 
            border-radius: 12px; 
            padding: 3px; 
        }

        .favorite-item:hover .favorite-actions {
            opacity: 1;
            visibility: visible; 
        }

        .action-btn {
            background-color: transparent;
            border: none; 
            color: white; 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            font-size: 12px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 0; 
            transition: background-color 0.2s; 
        }

        .action-btn:hover {
            background-color: rgba(59, 130, 246, 0.5);
        }

        .delete-fav-btn:hover {
            background-color: rgba(239, 68, 68, 0.5);
        }

        /* --- Estilos de Hierarquia (Subgrupos) --- */
        .subgroup-container {
            margin-top: 1.5rem;
            padding-left: 1rem;
            border-left: 2px solid var(--border-color);
        }

        .subgroup {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .subgroup:last-child {
            margin-bottom: 0;
        }

        /* --- Estilos do Modal --- */
        .modal {
            display: none;
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px); 
            align-items: center; 
            justify-content: center; 
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--group-background);
            padding: 2rem; 
            border-radius: 16px; 
            border: 1px solid var(--border-color); 
            width: 90%; 
            max-width: 400px; 
            position: relative;
        }

        .modal-content .close-btn {
            position: absolute;
            top: 10px; 
            right: 20px; 
            color: var(--text-color); 
            font-size: 2rem; 
            font-weight: bold; 
            cursor: pointer;
        }
        
        .modal-content h3 {
            margin-bottom: 1.5rem;
            text-align: center; 
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem; 
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem; 
            background-color: rgba(0, 0, 0, 0.2); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            color: var(--text-color); 
            font-size: 1rem;
        }
        
        .btn-primary {
            width: 100%;
            padding: 0.75rem; 
            border: none; 
            border-radius: 8px; 
            background-color: #3b82f6; 
            color: white; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 1rem;
        }

        /* Classe utilit√°ria para esconder elementos */
        .hidden {
            display: none !important;
        }

        /* Menus de Contexto */
        .context-menu-wrapper {
            display: none;
            position: absolute; 
            background-color: var(--group-background); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.3); 
            z-index: 1100; 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); 
        }

        .context-menu-wrapper.show {
            display: block;
        }

        .context-menu-wrapper ul {
            list-style: none;
            padding: 0.5rem 0; 
            margin: 0; 
        }

        .context-menu-wrapper li {
            padding: 0.75rem 1.5rem;
            cursor: pointer; 
            transition: background-color 0.2s; 
            white-space: nowrap; 
        }
        
        .context-menu-wrapper li:hover {
            background-color: rgba(59, 130, 246, 0.2);
        }

        #group-context-menu {
            width: 180px;
            box-sizing: border-box; 
        }

        #group-context-menu li {
            padding: 0.75rem 1rem;
        }

        /* --- Estilos para Drag and Drop --- */
        .favorite-item.dragging {
            opacity: 0.5;
            cursor: grabbing; 
        }

        .group.dragging-group {
            opacity: 0.5;
            position: fixed;
            z-index: 2000;
            pointer-events: none;
        }
        
        .placeholder {
            border-radius: 16px;
            border: 2px dashed rgba(255, 255, 255, 0.4);
            background-color: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }

        .favorites-grid.drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            border: 2px dashed rgba(59, 130, 246, 0.4); 
            border-radius: 12px; 
        }
        
        /* --- Estiliza√ß√£o da Barra de Rolagem Personalizada --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(17, 24, 39, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        #groups-container, .favorites-grid {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) rgba(17, 24, 39, 0.3);
        }

        .favorite-item .favicon-container .emoji-icon {
            font-size: 38px; /* Tamanho do emoji */
            line-height: 1;
            text-align: center;
        }

    </style>
</head>
<body>

    <div class="container">
        <header class="top-bar">
            <input type="search" id="search-bar" class="search-bar" placeholder="üîé Pesquisar">
            <button id="add-group-btn" class="top-bar-action-btn" title="Criar Novo Grupo">+</button>
            <button class="context-menu-btn" title="Menu">‚ãÆ</button>
        </header>

        <div id="context-menu" class="context-menu-wrapper">
            <ul>
                <li data-action="change-wallpaper">Trocar papel de parede</li>
                <li data-action="restore-wallpaper">Restaurar papel de parede</li>
                <li data-action="import">Importar favoritos</li>
                <li data-action="export">Exportar favoritos</li>
                <li data-action="create-group">Criar novo grupo</li>
                <li data-action="customize-layout">Personalizar</li>
                <li data-action="delete-all" style="color: #fca5a5;">Apagar Tudo</li>
            </ul>
        </div>

        <div id="group-context-menu" class="context-menu-wrapper">
            <ul>
                <li data-action="rename-group">Renomear Grupo</li> 
                <li data-action="delete-group" style="color: #fca5a5;">Excluir Grupo</li> 
            </ul>
        </div>

        <main id="groups-container">
            </main>
    </div>

    <div id="add-favorite-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">√ó</span>
            <h3 id="modal-title">Adicionar Novo Favorito</h3>
            <form id="add-favorite-form">
                <div class="form-group">
                    <label for="favorite-name">Nome</label>
                    <input type="text" id="favorite-name" required> 
                </div>
                <div class="form-group">
                    <label for="favorite-url">URL</label>
                    <input type="url" id="favorite-url" placeholder="https://exemplo.com" required> 
                </div>

                <div class="form-group">
                    <label>√çcone</label>
                    <div id="icon-choice-container" style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                        <label style="cursor:pointer;"><input type="radio" name="icon-type" value="default" checked> Padr√£o</label>
                        <label style="cursor:pointer;"><input type="radio" name="icon-type" value="emoji"> Emoji</label>
                        <label style="cursor:pointer;"><input type="radio" name="icon-type" value="image"> Imagem</label>
                    </div>
                    
                    <div id="emoji-input-container" class="hidden">
                        <input type="text" id="favorite-emoji" placeholder="Cole um emoji aqui, ex: ‚ú®" maxlength="2">
                    </div>

                    <div id="image-input-container" class="hidden" style="display: flex; align-items: center; gap: 10px;">
                        <button type="button" id="choose-icon-btn" class="btn-secondary" style="background-color: #555; width:auto; padding: 0.5rem 1rem; border:none; border-radius: 8px; color: white; cursor:pointer;">Escolher Imagem...</button>
                        <div id="icon-preview" style="width: 40px; height: 40px; background-color: rgba(0,0,0,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" id="modal-submit-btn">Salvar</button>
            </form>
        </div>
    </div>

    <input type="file" id="wallpaper-input" class="hidden" accept="image/*,.png,.jpg,.jpeg,.gif,.webp,.svg,.avif">
    <input type="file" id="import-input" class="hidden" accept=".html,text/html">
    <input type="file" id="favorite-icon-input" class="hidden" accept="image/*">

    <div id="customize-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">√ó</span>
            <h3>Personalizar Layout</h3>
            <form id="customize-form">
                <div class="form-group">
                    <label for="block-width-slider">Largura dos Blocos (<span id="block-width-value">320</span>px)</label>
                    <input type="range" id="block-width-slider" min="250" max="800" step="10">
                </div>
                <div class="form-group">
                    <label for="search-width-slider">Largura da Busca (<span id="search-width-value">500</span>px)</label>
                    <input type="range" id="search-width-slider" min="300" max="800" step="10">
                </div>
                <div class="form-group">
                    <label for="favorite-size-slider">Tamanho dos Favoritos (<span id="favorite-size-value">60</span>px)</label>
                    <input type="range" id="favorite-size-slider" min="40" max="90" step="1">
                </div>
                <div class="form-group">
                    <label for="center-blocks-checkbox" style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" id="center-blocks-checkbox" style="width: auto; height: auto; margin-right: 10px; cursor: pointer;">
                        Centralizar Blocos (Layout em Grade)
                    </label>
                </div>
                <div class="form-group">
                    <label for="masonry-layout-checkbox" style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" id="masonry-layout-checkbox" style="width: auto; height: auto; margin-right: 10px; cursor: pointer;">
                        Layout Mosaico (Estilo Pinterest)
                    </label>
                </div>
                <button type="submit" class="btn-primary">Salvar Altera√ß√µes</button>
                <button type="button" id="reset-width-btn" class="btn-secondary" style="background-color: #555; margin-top: 10px; width:100%; padding: 0.75rem; border:none; border-radius: 8px; color: white; cursor:pointer;">Redefinir para o Padr√£o</button>
            </form>
        </div>
    </div>

<script>
    // --- Fun√ß√µes de Exporta√ß√£o (Hier√°rquica) ---
    function generateExportHTML() {
        let htmlContent = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
    <TITLE>Bookmarks</TITLE>
    <H1>Bookmarks</H1>
    <DL><p>`;

        function buildHtmlForGroups(groups) {
            groups.forEach(group => {
                htmlContent += `\n<DT><H3>${group.name}</H3>`;
                htmlContent += `\n<DL><p>`;
                if (group.favorites) {
                    group.favorites.forEach(fav => {
                        htmlContent += `\n<DT><A HREF="${fav.url}">${fav.name}</A>`;
                    });
                }
                if (group.subgroups && group.subgroups.length > 0) {
                    buildHtmlForGroups(group.subgroups);
                }
                htmlContent += `\n</DL><p>`;
            });
        }
        
        buildHtmlForGroups(appData.groups);
        htmlContent += `\n</DL><p>`;
        return htmlContent;
    }

    function exportFavorites() {
        const htmlContent = generateExportHTML();
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `favoritos_exportados_${new Date().toLocaleDateString()}.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }
    
    // --- Camada de L√≥gica e Persist√™ncia ---
    const defaultData = {
        "groups": [
            {
                "id": "1",
                "name": "Favoritos",
                "favorites": []
            }
        ],
        "background": null,
        "settings": {
            "blockWidth": 320,
            "centerBlocks": false,
            "masonryLayout": false,
            "searchBarWidth": 500,
            "favoriteSize": 60
        }
    };

    let appData = {};
    // [NOVO] Vari√°vel para guardar as configura√ß√µes antes da edi√ß√£o
    let originalSettingsBeforeCustomization = null;

    function loadData() {
        const savedData = localStorage.getItem('launcherFavorites');
        appData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(defaultData));

        if (!appData.settings) {
            appData.settings = defaultData.settings;
        }
    }

    function saveData() {
        localStorage.setItem('launcherFavorites', JSON.stringify(appData));
    }

    // --- Fun√ß√µes de Papel de Parede ---
    function applyWallpaper() {
        const savedWallpaper = appData.background;
        if (savedWallpaper) {
            document.body.style.backgroundImage = `url(${savedWallpaper})`;
        } else {
            document.body.style.backgroundImage = 'linear-gradient(145deg, var(--background-start), var(--background-end))';
        }
    }

    function handleFavoriteIconSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const MAX_SIZE = 128; // √çcones podem ser menores, 128x128 √© suficiente
        const img = new Image();
        const reader = new FileReader();

        img.onload = () => {
            let { width, height } = img;
            if (width > MAX_SIZE || height > MAX_SIZE) {
                if (width > height) {
                    height = (MAX_SIZE / width) * height;
                    width = MAX_SIZE;
                } else {
                    width = (MAX_SIZE / height) * width;
                    height = MAX_SIZE;
                }
            }
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Usar PNG para manter a transpar√™ncia, se houver
            const resizedImageDataUrl = canvas.toDataURL('image/png'); 
            
            // Salva na vari√°vel tempor√°ria e mostra a pr√©-visualiza√ß√£o
            editedFavoriteIconData = resizedImageDataUrl;
            document.getElementById('icon-preview').innerHTML = `<img src="${resizedImageDataUrl}" style="width:100%; height:100%; object-fit:cover;">`;
            
            URL.revokeObjectURL(img.src);
        };

        reader.onload = (e) => { img.src = e.target.result; };
        reader.readAsDataURL(file);
    }

    function handleWallpaperSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const MAX_WIDTH_OR_HEIGHT = 1920;
        const img = new Image();
        const reader = new FileReader();

        img.onload = () => {
            let { width, height } = img;

            if (width > MAX_WIDTH_OR_HEIGHT || height > MAX_WIDTH_OR_HEIGHT) {
                if (width > height) {
                    height = (MAX_WIDTH_OR_HEIGHT / width) * height;
                    width = MAX_WIDTH_OR_HEIGHT;
                } else {
                    width = (MAX_WIDTH_OR_HEIGHT / height) * width;
                    height = MAX_WIDTH_OR_HEIGHT;
                }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const resizedImageDataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            appData.background = resizedImageDataUrl;
            saveData();
            applyWallpaper();
            
            URL.revokeObjectURL(img.src);
        };
        
        reader.onload = (e) => {
            img.src = e.target.result;
        };
        
        reader.readAsDataURL(file);
    }

    function openWallpaperSelector() {
        document.getElementById('wallpaper-input').click();
    }

    function restoreDefaultWallpaper() {
        appData.background = null;
        saveData();
        applyWallpaper();
    }
    
    // --- Fun√ß√µes de Importa√ß√£o ---
    function parseBookmarks(htmlString) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const mainDl = doc.querySelector('dl');
        if (!mainDl) {
            alert('Arquivo de favoritos inv√°lido ou em formato n√£o reconhecido.');
            return [];
        }
        return buildTree(mainDl);
    }

    function buildTree(dlElement) {
        const items = [];
        const dtElements = dlElement.querySelectorAll(':scope > dt');
        dtElements.forEach(dt => {
            const h3 = dt.querySelector('h3');
            if (h3) {
                const folderName = h3.textContent.trim();
                let nextDl = null;
                let sibling = dt.nextElementSibling;
                while (sibling) {
                    if (sibling.tagName === 'DL') {
                        nextDl = sibling;
                        break;
                    }
                    if (sibling.tagName === 'DT') {
                        break;
                    }
                    sibling = sibling.nextElementSibling;
                }
                const nestedDl = dt.querySelector('dl');
                const children = nestedDl ? buildTree(nestedDl) : (nextDl ? buildTree(nextDl) : []);
                items.push({ type: 'folder', name: folderName, children: children });
            } else {
                const link = dt.querySelector('a');
                if (link) {
                    items.push({ type: 'bookmark', name: link.textContent.trim(), url: link.href });
                }
            }
        });
        return items;
    }

    function convertTreeToAppGroups(tree) {
        const groups = [];
        const topLevelFolders = tree.filter(item => item.type === 'folder');
        const topLevelBookmarks = tree.filter(item => item.type === 'bookmark');
        if (topLevelBookmarks.length > 0) {
            groups.push({
                id: `group-${Date.now()}-root`,
                name: 'Favoritos Raiz',
                favorites: topLevelBookmarks.map(b => ({
                    id: `fav-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    name: b.name,
                    url: b.url
                })),
                subgroups: []
            });
        }
        topLevelFolders.forEach(folder => {
            groups.push(convertFolderToGroup(folder, `group-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`));
        });
        return groups;
    }

    function convertFolderToGroup(folder, id) {
        const group = { id: id, name: folder.name, favorites: [], subgroups: [] };
        folder.children.forEach(child => {
            if (child.type === 'bookmark') {
                group.favorites.push({
                    id: `fav-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    name: child.name,
                    url: child.url
                });
            } else if (child.type === 'folder') {
                group.subgroups.push(convertFolderToGroup(child, `group-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`));
            }
        });
        return group;
    }
    
    function handleImportSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const parsedTree = parseBookmarks(e.target.result);
                const importedGroups = convertTreeToAppGroups(parsedTree);
                if (importedGroups.length > 0) {
                    appData.groups = [...appData.groups, ...importedGroups];
                    saveData();
                    renderAndLayout();
                    alert(`Importa√ß√£o conclu√≠da! ${importedGroups.length} novo(s) grupo(s) adicionado(s).`);
                } else {
                    alert('Nenhuma pasta de favoritos encontrada para importar como grupo.');
                }
            } catch (error) {
                console.error('Erro ao importar favoritos:', error);
                alert('Ocorreu um erro ao tentar importar o arquivo.');
            }
        };
        reader.readAsText(file);
    }
    
    function openImportSelector() {
        document.getElementById('import-input').click();
    }
    
    // --- L√≥gica de Layout ---
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    function applyMasonryLayout() {
        const groupsContainer = document.getElementById('groups-container');
        const groupElements = groupsContainer.querySelectorAll('.group:not([style*="display: none"])');
        if (groupElements.length === 0) {
            groupsContainer.style.height = '0px'; // [NOVO] Garante que o container encolha se todos os grupos forem escondidos
            return;
        }

        const gap = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--layout-gap'), 10) || 32;
        const itemWidth = parseInt(document.getElementById('block-width-slider').value, 10) || 320;
        const containerWidth = groupsContainer.offsetWidth;
        const numColumns = Math.max(1, Math.floor(containerWidth / (itemWidth + gap)));
        
        const columnHeights = Array(numColumns).fill(0);
        const columnLefts = [];
        const effectiveItemWidth = (containerWidth - (numColumns - 1) * gap) / numColumns;
        
        for (let i = 0; i < numColumns; i++) {
            columnLefts.push(i * (effectiveItemWidth + gap));
        }

        groupElements.forEach(group => {
            group.style.width = `${effectiveItemWidth}px`;
            const shortestColumnIndex = columnHeights.indexOf(Math.min(...columnHeights));
            
            group.style.left = `${columnLefts[shortestColumnIndex]}px`;
            group.style.top = `${columnHeights[shortestColumnIndex]}px`;
            
            columnHeights[shortestColumnIndex] += group.offsetHeight + gap;
        });

        groupsContainer.style.height = `${Math.max(...columnHeights)}px`;
    }

    function resetLayoutStyles() {
        const groupsContainer = document.getElementById('groups-container');
        groupsContainer.style.height = '';
        groupsContainer.classList.remove('layout-centered', 'layout-masonry');
        groupsContainer.querySelectorAll('.group').forEach(group => {
            group.style.position = '';
            group.style.top = '';
            group.style.left = '';
            group.style.width = `${appData.settings.blockWidth || 320}px`;
        });
    }

    function applyLayoutSettings() {
        resetLayoutStyles();
        const groupsContainer = document.getElementById('groups-container');

        if (appData.settings && appData.settings.masonryLayout) {
            groupsContainer.classList.add('layout-masonry');
            setTimeout(applyMasonryLayout, 50); 
        } else if (appData.settings && appData.settings.centerBlocks) {
            groupsContainer.classList.add('layout-centered');
        }
    }
    
    function renderAndLayout() {
        render();
        applyLayoutSettings();
    }

    // --- Camada de Apresenta√ß√£o (Renderiza√ß√£o) ---
    function render() {
        const groupsContainer = document.getElementById('groups-container');
        groupsContainer.innerHTML = '';
        if (appData.groups && appData.groups.length > 0) {
            renderHierarquia(appData.groups, groupsContainer);
        }
    }

    function renderHierarquia(groups, container, isSubgroup = false) {
        groups.forEach(group => {
            const groupElement = document.createElement('section');
            groupElement.className = 'group';
            if (isSubgroup) groupElement.classList.add('subgroup');
            groupElement.dataset.groupId = group.id;
            
            const blockWidth = appData.settings.blockWidth || 320;
            groupElement.style.width = `${blockWidth}px`;

            groupElement.innerHTML = `
                <div class="group-header">
                    <h2>${group.name}</h2>
                    <div class="group-header-actions">
                        <button class="add-favorite-btn" title="Adicionar Favorito">+</button>
                        <button class="group-context-btn" title="Op√ß√µes do Grupo">‚ãÆ</button>
                    </div>
                </div>
                <div class="favorites-grid"></div>
                <div class="subgroup-container"></div>
            `;
            
            const favoritesGrid = groupElement.querySelector('.favorites-grid');
            if (group.favorites) {
                group.favorites.forEach(fav => {
                    const favoriteElement = document.createElement('div');
                    favoriteElement.className = 'favorite-item';
                    favoriteElement.draggable = true;
                    favoriteElement.dataset.favoriteId = fav.id;
                    favoriteElement.dataset.url = fav.url;

                    let iconHTML = '';
                    if (fav.icon && fav.icon.startsWith('data:image')) {
                        // Renderiza imagem customizada
                        iconHTML = `<img src="${fav.icon}" alt="">`;
                    } else if (fav.icon) {
                        // Renderiza emoji
                        iconHTML = `<span class="emoji-icon">${fav.icon}</span>`;
                    } else {
                        // Renderiza o favicon padr√£o
                        const faviconUrl = `https://www.google.com/s2/favicons?sz=64&domain_url=${encodeURIComponent(fav.url)}`;
                        iconHTML = `<img src="${faviconUrl}" alt="" onerror="this.style.display='none'">`;
                    }

                    favoriteElement.innerHTML = `
                        <div class="favorite-actions">
                            <button class="action-btn edit-fav-btn" title="Editar">‚úèÔ∏è</button>
                            <button class="action-btn delete-fav-btn" title="Excluir">‚ùå</button>
                        </div>
                        <div class="favicon-container" title="${fav.name}">
                            ${iconHTML}
                        </div>
                        <span class="name">${fav.name}</span>
                    `;
                    favoritesGrid.appendChild(favoriteElement);
                });
            }
            
            if (group.subgroups && group.subgroups.length > 0) {
                const subgroupContainer = groupElement.querySelector('.subgroup-container');
                renderHierarquia(group.subgroups, subgroupContainer, true);
            }
            
            container.appendChild(groupElement);
        });
    }

    // --- Inicializa√ß√£o e Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        applyDynamicStyles();
        applyWallpaper();
        renderAndLayout();
        
        window.addEventListener('resize', debounce(() => {
            if (appData.settings.masonryLayout) {
                applyMasonryLayout();
            }
        }, 250));

        const groupsContainer = document.getElementById('groups-container');
        const searchBar = document.getElementById('search-bar');
        const modal = document.getElementById('add-favorite-modal');
        const closeModalBtn = modal.querySelector('.close-btn');
        const addFavoriteForm = document.getElementById('add-favorite-form');
        const contextMenuBtn = document.querySelector('.context-menu-btn');
        const contextMenu = document.getElementById('context-menu');
        const groupContextMenu = document.getElementById('group-context-menu');
        const wallpaperInput = document.getElementById('wallpaper-input');
        const importInput = document.getElementById('import-input');
        
        let currentGroupId = null;
        let editState = { enabled: false, favoriteId: null };
        let activeGroupId = null;
        let editedFavoriteIconData = null; // <-- NOVA VARI√ÅVEL GLOBAL (no escopo)

        // L√≥gica para controlar a UI de sele√ß√£o de √≠cone no modal
        const iconTypeRadios = document.querySelectorAll('input[name="icon-type"]');
        const emojiContainer = document.getElementById('emoji-input-container');
        const imageContainer = document.getElementById('image-input-container');
        const favoriteEmojiInput = document.getElementById('favorite-emoji');
        const iconPreview = document.getElementById('icon-preview');

        iconTypeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                emojiContainer.classList.add('hidden');
                imageContainer.classList.add('hidden');
                if (radio.value === 'emoji') {
                    emojiContainer.classList.remove('hidden');
                    imageContainer.classList.remove('hidden'); // Manter preview vis√≠vel
                } else if (radio.value === 'image') {
                    imageContainer.classList.remove('hidden');
                }
            });
        });

        document.getElementById('choose-icon-btn').addEventListener('click', () => {
            document.getElementById('favorite-icon-input').click();
        });

        document.getElementById('favorite-icon-input').addEventListener('change', handleFavoriteIconSelect);

        favoriteEmojiInput.addEventListener('input', () => {
            iconPreview.innerHTML = `<span class="emoji-icon">${favoriteEmojiInput.value}</span>`;
        });

        function findGroupData(groupId, groupsArray) {
            for (let i = 0; i < groupsArray.length; i++) {
                const group = groupsArray[i];
                if (group.id === groupId) {
                    return { group: group, parentArray: groupsArray, index: i };
                }
                if (group.subgroups && group.subgroups.length > 0) {
                    const found = findGroupData(groupId, group.subgroups);
                    if (found) return found;
                }
            }
            return null;
        }
        
        let draggedGroup = null;
        let placeholder = null;
        let isDraggingGroup = false;
        let dragOffsetX = 0, dragOffsetY = 0;

        groupsContainer.addEventListener('pointerdown', e => {
            if (appData.settings.masonryLayout) return; 
            if (e.target.closest('.favorite-item')) return; 

            const groupHeader = e.target.closest('.group-header');
            if (!groupHeader || e.button !== 0) return;

            e.preventDefault();
            draggedGroup = groupHeader.closest('.group');
            const rect = draggedGroup.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;

            document.addEventListener('pointermove', onGroupPointerMove);
            document.addEventListener('pointerup', onGroupPointerUp);
        });

        function onGroupPointerMove(e) {
            e.preventDefault();
            if (!draggedGroup) return;

            if (!isDraggingGroup) {
                isDraggingGroup = true;
                const rect = draggedGroup.getBoundingClientRect();
                placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.style.width = `${rect.width}px`;
                placeholder.style.height = `${rect.height}px`;
                groupsContainer.insertBefore(placeholder, draggedGroup);
                draggedGroup.classList.add('dragging-group');
                draggedGroup.style.width = `${rect.width}px`;
                document.body.appendChild(draggedGroup);
            }
            
            draggedGroup.style.left = `${e.clientX - dragOffsetX}px`;
            draggedGroup.style.top = `${e.clientY - dragOffsetY}px`;

            document.querySelectorAll('.group.drop-target-group').forEach(g => g.classList.remove('drop-target-group'));
            let dropTarget = e.target.closest('.group:not(.dragging-group)');
            if (dropTarget) {
                 dropTarget.classList.add('drop-target-group');
                 placeholder.style.display = 'none';
            } else {
                 placeholder.style.display = 'block';
                 const children = [...groupsContainer.children].filter(c => c !== placeholder && c !== draggedGroup);
                 let found = false;
                 for(let i=0; i < children.length; i++) {
                     const child = children[i];
                     const box = child.getBoundingClientRect();
                     if(e.clientX < box.left + box.width / 2) {
                         groupsContainer.insertBefore(placeholder, child);
                         found = true;
                         break;
                     }
                 }
                 if (!found) groupsContainer.appendChild(placeholder);
            }
        }
        
        function onGroupPointerUp(e) {
            if (!isDraggingGroup) {
                document.removeEventListener('pointermove', onGroupPointerMove);
                document.removeEventListener('pointerup', onGroupPointerUp);
                return;
            }

            const draggedGroupId = draggedGroup.dataset.groupId;
            const dropTargetElement = document.querySelector('.group.drop-target-group');
            const sourceInfo = findGroupData(draggedGroupId, appData.groups);

            if (dropTargetElement) {
                const targetGroupId = dropTargetElement.dataset.groupId;
                const targetInfo = findGroupData(targetGroupId, appData.groups);
                if (sourceInfo && targetInfo && sourceInfo.group.id !== targetInfo.group.id) {
                    const [movedGroup] = sourceInfo.parentArray.splice(sourceInfo.index, 1);
                    if(!targetInfo.group.subgroups) targetInfo.group.subgroups = [];
                    targetInfo.group.subgroups.push(movedGroup);
                }
            } else if (placeholder) {
                const finalIndex = [...groupsContainer.children].indexOf(placeholder);
                if (sourceInfo) {
                    const [movedGroup] = sourceInfo.parentArray.splice(sourceInfo.index, 1);
                    appData.groups.splice(finalIndex, 0, movedGroup);
                }
            }

            saveData();
            
            if (placeholder) placeholder.remove();
            if (draggedGroup) draggedGroup.remove(); 
            
            document.querySelectorAll('.group.drop-target-group').forEach(g => g.classList.remove('drop-target-group'));

            draggedGroup = null; 
            placeholder = null; 
            isDraggingGroup = false;
            document.removeEventListener('pointermove', onGroupPointerMove);
            document.removeEventListener('pointerup', onGroupPointerUp);

            renderAndLayout();
        }

        let draggedItem = null;
        let sourceGroupId = null;

        groupsContainer.addEventListener('dragstart', (e) => {
            const favoriteItem = e.target.closest('.favorite-item');
            if (favoriteItem) {
                draggedItem = favoriteItem;
                sourceGroupId = favoriteItem.closest('.group').dataset.groupId;
                setTimeout(() => favoriteItem.classList.add('dragging'), 0);
            }
        });

        groupsContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            const targetGrid = e.target.closest('.favorites-grid');
            if(targetGrid){
                document.querySelectorAll('.favorites-grid.drag-over').forEach(grid => grid.classList.remove('drag-over'));
                targetGrid.classList.add('drag-over');
            }
        });

        groupsContainer.addEventListener('dragleave', (e) => {
            const targetGrid = e.target.closest('.favorites-grid');
            if (targetGrid) targetGrid.classList.remove('drag-over');
        });

        groupsContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const targetGroupElement = e.target.closest('.group');
            if (!targetGroupElement || !draggedItem) return;

            const targetGroupId = targetGroupElement.dataset.groupId;
            const favoriteId = draggedItem.dataset.favoriteId;

            const sourceInfo = findGroupData(sourceGroupId, appData.groups);
            const targetInfo = findGroupData(targetGroupId, appData.groups);

            if (!sourceInfo || !targetInfo) return;

            const favIndex = sourceInfo.group.favorites.findIndex(f => f.id === favoriteId);
            if (favIndex === -1) return;

            const [favoriteToMove] = sourceInfo.group.favorites.splice(favIndex, 1);

            if (!targetInfo.group.favorites) targetInfo.group.favorites = [];

            const afterElement = e.target.closest('.favorite-item');

            if (afterElement) {
                const afterFavoriteId = afterElement.dataset.favoriteId;
                const insertAtIndex = targetInfo.group.favorites.findIndex(f => f.id === afterFavoriteId);

                if (insertAtIndex !== -1) {
                    targetInfo.group.favorites.splice(insertAtIndex, 0, favoriteToMove);
                } else {
                    targetInfo.group.favorites.push(favoriteToMove);
                }
            } else {
                targetInfo.group.favorites.push(favoriteToMove);
            }

            saveData();
            renderAndLayout();
        });

        groupsContainer.addEventListener('dragend', (e) => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                document.querySelectorAll('.favorites-grid.drag-over').forEach(grid => grid.classList.remove('drag-over'));
                draggedItem = null;
                sourceGroupId = null;
            }
        });

        window.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && !contextMenuBtn.contains(e.target)) contextMenu.classList.remove('show');
            if (!groupContextMenu.contains(e.target) && !e.target.classList.contains('group-context-btn')) groupContextMenu.classList.remove('show');
        });

        contextMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            groupContextMenu.classList.remove('show');
            const rect = e.target.getBoundingClientRect();
            contextMenu.style.top = `${rect.bottom + 5}px`; 
            contextMenu.style.left = 'auto'; 
            contextMenu.style.right = `${window.innerWidth - rect.right}px`; 
            contextMenu.classList.toggle('show');
        });

        contextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!action) return;            
            switch (action) {
                case 'change-wallpaper': openWallpaperSelector(); break;
                case 'restore-wallpaper': restoreDefaultWallpaper(); break;
                case 'import': openImportSelector(); break;
                case 'export': exportFavorites(); break;
                case 'create-group':
                    createNewGroup();
                    break;
                case 'customize-layout':
                    openCustomizeModal();
                    contextMenu.classList.remove('show');
                    break;
                case 'delete-all':
                    if (confirm('Tem certeza que deseja excluir todos os favoritos? Esta a√ß√£o √© irrevers√≠vel.')) {
                        appData.groups = [];
                        saveData();
                        renderAndLayout();
                    }
                    break;
            }
            contextMenu.classList.remove('show');
        });

        groupContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!action || !activeGroupId) return;

            const groupInfo = findGroupData(activeGroupId, appData.groups);
            if (!groupInfo) return;

            if (action === 'rename-group') {
                const newName = prompt('Digite o novo nome para o grupo:', groupInfo.group.name);
                if (newName && newName.trim()) {
                    groupInfo.group.name = newName.trim();
                }
            } else if (action === 'delete-group') {
                if (confirm(`Tem certeza que deseja excluir o grupo "${groupInfo.group.name}" e todos os seus itens?`)) {
                    groupInfo.parentArray.splice(groupInfo.index, 1);
                }
            }

            saveData();
            renderAndLayout();
            groupContextMenu.classList.remove('show');
        });
        
        groupsContainer.addEventListener('click', (e) => {
            const target = e.target;
            const groupElement = target.closest('.group');
            if (!groupElement) return;

            if (target.classList.contains('add-favorite-btn')) {
                currentGroupId = groupElement.dataset.groupId;
                openModal(false);
                return;
            }

            if (target.classList.contains('group-context-btn')) {
                e.stopPropagation();
                activeGroupId = groupElement.dataset.groupId;
                const rect = target.getBoundingClientRect();
                contextMenu.classList.remove('show');
                groupContextMenu.style.top = `${rect.bottom + 5}px`;
                groupContextMenu.style.left = `${rect.right - groupContextMenu.offsetWidth}px`;
                groupContextMenu.classList.add('show');
                return;
            }
            
            const favoriteElement = target.closest('.favorite-item');
            if (!favoriteElement) return;

            const favoriteId = favoriteElement.dataset.favoriteId;
            const groupId = groupElement.dataset.groupId;
            const groupInfo = findGroupData(groupId, appData.groups);

            if (target.classList.contains('edit-fav-btn')) {
                e.preventDefault(); e.stopPropagation();
                const favorite = groupInfo.group.favorites.find(f => f.id === favoriteId);
                if (favorite) {
                    currentGroupId = groupId;
                    editState = { enabled: true, favoriteId: favorite.id };
                    openModal(true, favorite);
                }
                return;
            }

            if (target.classList.contains('delete-fav-btn')) {
                e.preventDefault(); e.stopPropagation();
                const favIndex = groupInfo.group.favorites.findIndex(f => f.id === favoriteId);
                if (favIndex !== -1 && confirm(`Excluir "${groupInfo.group.favorites[favIndex].name}"?`)) {
                    groupInfo.group.favorites.splice(favIndex, 1);
                    saveData();
                    renderAndLayout();
                }
                return;
            }
            
            const url = favoriteElement.dataset.url;
            if(url) window.open(url, '_blank');
        });

        function openModal(isEdit, favorite = null) {
            // Reseta o estado do √≠cone antes de abrir
            editedFavoriteIconData = null;
            document.getElementById('icon-preview').innerHTML = '';
            document.querySelector('input[name="icon-type"][value="default"]').checked = true;
            document.getElementById('emoji-input-container').classList.add('hidden');
            document.getElementById('image-input-container').classList.add('hidden');
            document.getElementById('favorite-emoji').value = '';

            modal.querySelector('h3').textContent = isEdit ? 'Editar Favorito' : 'Adicionar Novo Favorito';
            document.getElementById('favorite-name').value = isEdit ? favorite.name : '';
            document.getElementById('favorite-url').value = isEdit ? favorite.url : '';

            // L√≥gica para preencher o √≠cone existente
            if (isEdit && favorite.icon) {
                if (favorite.icon.startsWith('data:image')) {
                    // √â uma imagem customizada
                    document.querySelector('input[name="icon-type"][value="image"]').checked = true;
                    document.getElementById('image-input-container').classList.remove('hidden');
                    document.getElementById('icon-preview').innerHTML = `<img src="${favorite.icon}" style="width:100%; height:100%; object-fit:cover;">`;
                    editedFavoriteIconData = favorite.icon; // Armazena o √≠cone atual
                } else {
                    // √â um emoji
                    document.querySelector('input[name="icon-type"][value="emoji"]').checked = true;
                    document.getElementById('emoji-input-container').classList.remove('hidden');
                    document.getElementById('image-input-container').classList.remove('hidden');
                    document.getElementById('favorite-emoji').value = favorite.icon;
                    document.getElementById('icon-preview').innerHTML = `<span class="emoji-icon">${favorite.icon}</span>`;
                }
            }

            modal.classList.add('show');
            document.getElementById('favorite-name').focus();
        }

        function closeModal() {
            addFavoriteForm.reset();
            modal.classList.remove('show');
            currentGroupId = null;
            editState = { enabled: false, favoriteId: null };
        }

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => e.target === modal && closeModal());

        addFavoriteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('favorite-name').value.trim();
            const url = document.getElementById('favorite-url').value.trim();
            if (!name || !url) return;
            
            const groupInfo = findGroupData(currentGroupId, appData.groups);
            if (!groupInfo) return;

            // Objeto base do favorito
            const newFavoriteData = { name, url, id: 'fav' + Date.now() };

            // L√≥gica para adicionar o √≠cone
            const iconType = document.querySelector('input[name="icon-type"]:checked').value;
            if (iconType === 'image' && editedFavoriteIconData) {
                newFavoriteData.icon = editedFavoriteIconData;
            } else if (iconType === 'emoji') {
                newFavoriteData.icon = document.getElementById('favorite-emoji').value.trim();
            } else {
                newFavoriteData.icon = null; // Garante que seja nulo para o padr√£o
            }

            if (editState.enabled) {
                const favorite = groupInfo.group.favorites.find(f => f.id === editState.favoriteId);
                if (favorite) {
                    favorite.name = newFavoriteData.name;
                    favorite.url = newFavoriteData.url;
                    favorite.icon = newFavoriteData.icon; // Atualiza o √≠cone
                }
            } else {
                if (!groupInfo.group.favorites) groupInfo.group.favorites = [];
                groupInfo.group.favorites.push(newFavoriteData);
            }
            
            saveData();
            renderAndLayout();
            closeModal();
        });

        searchBar.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            document.querySelectorAll('.group').forEach(groupEl => {
                let hasVisibleFavorites = false;
                groupEl.querySelectorAll('.favorite-item').forEach(favEl => {
                    const name = favEl.querySelector('.name').textContent.toLowerCase();
                    const isVisible = name.includes(query);
                    favEl.style.display = isVisible ? '' : 'none';
                    if (isVisible) hasVisibleFavorites = true;
                });
                const groupTitle = groupEl.querySelector('h2').textContent.toLowerCase();
                groupEl.style.display = (groupTitle.includes(query) || hasVisibleFavorites) ? '' : 'none';
            });
            
            if (appData.settings.masonryLayout) {
                // [ALTERADO] Atraso para garantir que o DOM foi atualizado antes de recalcular
                setTimeout(applyMasonryLayout, 50); 
            }
        });

        wallpaperInput.addEventListener('change', handleWallpaperSelect);
        importInput.addEventListener('change', handleImportSelect);

        // --- [SE√á√ÉO ALTERADA] L√≥gica do modal de personaliza√ß√£o ---
        const customizeModal = document.getElementById('customize-modal');
        const closeCustomizeModalBtn = customizeModal.querySelector('.close-btn');
        const customizeForm = document.getElementById('customize-form');
        const blockWidthSlider = document.getElementById('block-width-slider');
        const blockWidthValueSpan = document.getElementById('block-width-value');
        const searchWidthSlider = document.getElementById('search-width-slider');
        const searchWidthValueSpan = document.getElementById('search-width-value');
        const favoriteSizeSlider = document.getElementById('favorite-size-slider');
        const favoriteSizeValueSpan = document.getElementById('favorite-size-value');
        const resetWidthBtn = document.getElementById('reset-width-btn');
        const centerBlocksCheckbox = document.getElementById('center-blocks-checkbox');
        const masonryLayoutCheckbox = document.getElementById('masonry-layout-checkbox');
        const DEFAULT_BLOCK_WIDTH = 320;

        function openCustomizeModal() {
            // [NOVO] Guarda uma c√≥pia profunda das configura√ß√µes atuais ao abrir o modal
            originalSettingsBeforeCustomization = JSON.parse(JSON.stringify(appData.settings));

            if (!appData.settings) appData.settings = JSON.parse(JSON.stringify(defaultData.settings));
            
            const settings = appData.settings;
            blockWidthSlider.value = settings.blockWidth || DEFAULT_BLOCK_WIDTH;
            blockWidthValueSpan.textContent = settings.blockWidth || DEFAULT_BLOCK_WIDTH;
            searchWidthSlider.value = settings.searchBarWidth || 500;
            searchWidthValueSpan.textContent = settings.searchBarWidth || 500;
            favoriteSizeSlider.value = settings.favoriteSize || 60;
            favoriteSizeValueSpan.textContent = settings.favoriteSize || 60;
            centerBlocksCheckbox.checked = settings.centerBlocks || false;
            masonryLayoutCheckbox.checked = settings.masonryLayout || false;

            customizeModal.classList.add('show');
        }

        // [NOVO] Fun√ß√£o para aplicar os estilos e layout da pr√©-visualiza√ß√£o
        function applyLivePreview() {
            const root = document.documentElement;
            const groupsContainer = document.getElementById('groups-container');

            // Atualiza os valores dos spans
            blockWidthValueSpan.textContent = blockWidthSlider.value;
            searchWidthValueSpan.textContent = searchWidthSlider.value;
            favoriteSizeValueSpan.textContent = favoriteSizeSlider.value;

            // Aplica estilos din√¢micos (CSS variables)
            root.style.setProperty('--search-bar-width', `${searchWidthSlider.value}px`);
            const favSize = parseInt(favoriteSizeSlider.value, 10);
            root.style.setProperty('--favorite-item-size', `${favSize}px`);
            const fontSize = 0.8 * (favSize / 60);
            root.style.setProperty('--favorite-font-size', `${fontSize.toFixed(2)}rem`);

            // Aplica largura dos blocos
            document.querySelectorAll('.group').forEach(group => {
                group.style.width = `${blockWidthSlider.value}px`;
            });

            // Reseta e aplica o layout (grade ou mosaico)
            resetLayoutStyles();
            if (masonryLayoutCheckbox.checked) {
                groupsContainer.classList.add('layout-masonry');
                // Usa o valor do slider diretamente para o c√°lculo
                setTimeout(() => applyMasonryLayout(), 50);
            } else if (centerBlocksCheckbox.checked) {
                groupsContainer.classList.add('layout-centered');
            } else {
                 // Garante que o container volte ao layout padr√£o se nenhuma caixa estiver marcada
                renderAndLayout();
            }
        }
        
        // [NOVO] Adiciona listeners para a pr√©-visualiza√ß√£o em tempo real
        blockWidthSlider.addEventListener('input', applyLivePreview);
        searchWidthSlider.addEventListener('input', applyLivePreview);
        favoriteSizeSlider.addEventListener('input', applyLivePreview);
        centerBlocksCheckbox.addEventListener('change', () => {
            if (centerBlocksCheckbox.checked) masonryLayoutCheckbox.checked = false;
            applyLivePreview();
        });
        masonryLayoutCheckbox.addEventListener('change', () => {
            if (masonryLayoutCheckbox.checked) centerBlocksCheckbox.checked = false;
            applyLivePreview();
        });

        // [ALTERADO] O submit agora apenas salva as configura√ß√µes que j√° est√£o sendo pr√©-visualizadas
        customizeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            appData.settings.blockWidth = parseInt(blockWidthSlider.value, 10);
            appData.settings.searchBarWidth = parseInt(searchWidthSlider.value, 10);
            appData.settings.favoriteSize = parseInt(favoriteSizeSlider.value, 10);
            appData.settings.centerBlocks = centerBlocksCheckbox.checked;
            appData.settings.masonryLayout = masonryLayoutCheckbox.checked;
            saveData();
            // A pr√©-visualiza√ß√£o j√° atualizou o layout, ent√£o s√≥ precisamos fechar o modal.
            customizeModal.classList.remove('show');
            originalSettingsBeforeCustomization = null; // Limpa o backup
        });
        
        // [ALTERADO] O bot√£o de reset agora tamb√©m aplica as mudan√ßas em tempo real
        resetWidthBtn.addEventListener('click', () => {
            // Atualiza os sliders para os valores padr√£o
            blockWidthSlider.value = DEFAULT_BLOCK_WIDTH;
            searchWidthSlider.value = 500;
            favoriteSizeSlider.value = 60;
            centerBlocksCheckbox.checked = false;
            masonryLayoutCheckbox.checked = false;
            // Aplica a pr√©-visualiza√ß√£o com os valores resetados
            applyLivePreview();
        });

        // [NOVO] Fun√ß√£o para reverter as altera√ß√µes e fechar o modal
        function revertAndCloseCustomization() {
            if (originalSettingsBeforeCustomization) {
                appData.settings = originalSettingsBeforeCustomization;
                originalSettingsBeforeCustomization = null;
                saveData(); // Salva para garantir consist√™ncia, opcional
                applyDynamicStyles();
                renderAndLayout();
            }
            customizeModal.classList.remove('show');
        }

        // [ALTERADO] Listeners de fechamento agora revertem as altera√ß√µes
        closeCustomizeModalBtn.addEventListener('click', revertAndCloseCustomization);
        customizeModal.addEventListener('click', (e) => {
            if (e.target === customizeModal) {
                revertAndCloseCustomization();
            }
        });

        const addGroupBtn = document.getElementById('add-group-btn');
        addGroupBtn.addEventListener('click', createNewGroup);
    });

    function applyDynamicStyles() {
        if (!appData.settings) return;
        const settings = appData.settings;
        const root = document.documentElement;

        root.style.setProperty('--search-bar-width', `${settings.searchBarWidth || 500}px`);

        const favSize = settings.favoriteSize || 60;
        root.style.setProperty('--favorite-item-size', `${favSize}px`);
        const fontSize = 0.8 * (favSize / 60);
        root.style.setProperty('--favorite-font-size', `${fontSize.toFixed(2)}rem`);
    }

    function createNewGroup() {
        const groupName = prompt('Digite o nome do novo grupo:');
        if (groupName && groupName.trim()) {
            if (!appData.groups) appData.groups = [];
            appData.groups.push({
                id: 'group' + Date.now(),
                name: groupName.trim(),
                favorites: [],
                subgroups: []
            });
            saveData();
            renderAndLayout();
        }
    }
</script>
</body>
</html>